<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Request Queue with Status</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        button, select, textarea, input { margin: 5px; padding: 8px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; vertical-align: top; }
        th { background-color: #f4f4f4; }
        textarea, input[type="text"], input[type="number"] { width: 100%; box-sizing: border-box; resize: vertical; }
        .status-expired { background-color: #ffe5e5; font-weight: bold; }
        .status-warning { background-color: #fffacc; }
        .status-processed { background-color: #e5ffe5; opacity: 0.7; }
        .status-clientRevisions { background-color: #e5f7ff; }
        .status-active { font-weight: bold; }

        /* Logo & header spacing */
        .logo {
            max-height: 150px;
            width: auto;
            display: block;
            margin: 0 auto 5px auto; /* Reduced bottom margin */
        }

        h2 {
            margin-top: 0; /* Remove default top margin */
            text-align: center;
        }

        @media (max-width: 600px) {
            .logo {
                max-height: 100px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>

<!-- Logo -->
<img src="logo.png" alt="Company Logo" class="logo">

<h2>CTC TCP Request Queue</h2>

<label for="requestInput"><strong>Request:</strong></label><br>
<textarea id="requestInput" placeholder="Enter request data" rows="3"></textarea><br>

<label for="emailInput"><strong>Email Link:</strong></label><br>
<input type="text" id="emailInput" placeholder="Enter email link (optional)"><br>

<select id="timeSelect">
    <option value="1">1 Business Day</option>
    <option value="2">2 Business Days</option>
    <option value="3">3 Business Days</option>
    <option value="4">4 Business Days</option>
    <option value="5">5 Business Days</option>
</select>

<button id="addRequestBtn">Add Request</button>

<br><br>
<label for="statusFilter"><strong>Filter by Status:</strong></label>
<select id="statusFilter">
    <option value="all">All</option>
    <option value="active">Active</option>
    <option value="clientRevisions">Needs Revisions</option>
    <option value="processed">Processed</option>
    <option value="late">Late</option>
</select>

<h3>Queue:</h3>
<table>
    <thead>
        <tr>
            <th>#</th>
            <th>Request</th>
            <th>Email Link</th>
            <th>Status</th>
            <th>Time Left</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="queueTableBody"></tbody>
</table>

<script>
let queue = [];
const STORAGE_KEY = "requestQueue";

function saveQueue() { localStorage.setItem(STORAGE_KEY, JSON.stringify(queue)); }
function loadQueue() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) queue = JSON.parse(data).map(req => ({
        ...req,
        timestamp: new Date(req.timestamp),
        deadline: new Date(req.deadline)
    }));
}

function addBusinessDays(startDate, days) {
    let date = new Date(startDate);
    let added = 0;
    while (added < days) {
        date.setDate(date.getDate() + 1);
        if (date.getDay() !== 0 && date.getDay() !== 6) added++;
    }
    date.setHours(0,0,0,0);
    return date;
}

function getBusinessDaysLeft(deadline) {
    const now = new Date();
    if (now >= deadline) return 0;
    let count = 0;
    let current = new Date(now);
    current.setHours(0,0,0,0);
    while (current < deadline) {
        if (current.getDay() !== 0 && current.getDay() !== 6) count++;
        current.setDate(current.getDate() + 1);
    }
    return count;
}

function formatTime(daysLeft) { return daysLeft <= 0 ? "0 days" : `${daysLeft} day${daysLeft !== 1 ? 's' : ''}`; }

function addRequest() {
    const requestInput = document.getElementById('requestInput').value.trim();
    const emailInput = document.getElementById('emailInput').value.trim();
    const businessDays = parseInt(document.getElementById('timeSelect').value);
    if (!requestInput || isNaN(businessDays)) return;

    const timestamp = new Date();
    const deadline = addBusinessDays(timestamp, businessDays);

    queue.push({
        id: `req_${Date.now()}`,
        data: requestInput,
        email: emailInput,
        timestamp,
        deadline,
        businessDays,
        status: "active",
        frozenTimeLeft: null
    });

    document.getElementById('requestInput').value = "";
    document.getElementById('emailInput').value = "";
    saveQueue();
    renderQueue();
}

function deleteRequest(id) {
    queue = queue.filter(req => req.id !== id);
    saveQueue();
    renderQueue();
}

function requestTimeInput(req, actionType) {
    const days = parseInt(prompt("Enter number of business days:", req.businessDays || 1));
    if (isNaN(days) || days <= 0) return;

    const now = new Date();
    req.timestamp = now;
    req.deadline = addBusinessDays(now, days);
    req.businessDays = days;
    req.status = actionType;
    req.frozenTimeLeft = null;

    saveQueue();
    renderQueue();
}

function renderQueue() {
    const tbody = document.getElementById("queueTableBody");
    tbody.innerHTML = "";
    const filter = document.getElementById("statusFilter").value;

    const sorted = [...queue].sort((a,b) => {
        const isActive = s => s==='active'||s==='clientRevisions';
        if (isActive(a.status) && !isActive(b.status)) return -1;
        if (!isActive(a.status) && isActive(b.status)) return 1;
        if (isActive(a.status) && isActive(b.status)) return a.deadline - b.deadline;
        return 0;
    });

    sorted.forEach((req, i) => {
        const daysLeft = getBusinessDaysLeft(req.deadline);
        const isLate = (req.status==='active'||req.status==='clientRevisions') && daysLeft <= 0;

        if (filter==='late' && !isLate) return;
        if (filter!=='all' && filter!=='late' && req.status!==filter) return;

        const row = document.createElement("tr");
        row.id = req.id;

        const emailHTML = req.email ? `<a href="${req.email}" target="_blank">${req.email}</a>` : `<em>No link</em>`;

        row.innerHTML = `
            <td>${i+1}</td>
            <td>${req.data.replace(/\n/g,"<br>")}</td>
            <td>${emailHTML}</td>
            <td class="status-cell"></td>
            <td class="timer-cell"></td>
            <td class="actions-cell"></td>
        `;

        tbody.appendChild(row);

        const actionsCell = row.querySelector('.actions-cell');
        actionsCell.innerHTML = "";
        if (req.status==='active') {
            const processBtn = document.createElement("button"); processBtn.textContent="Process";
            processBtn.onclick = () => { req.status='processed'; req.frozenTimeLeft=daysLeft; saveQueue(); renderQueue(); };
            const deleteBtn = document.createElement("button"); deleteBtn.textContent="Delete"; deleteBtn.onclick=()=>deleteRequest(req.id);
            actionsCell.append(processBtn, deleteBtn);
        } else if (req.status==='processed') {
            const reactBtn = document.createElement("button"); reactBtn.textContent="Re-activate";
            reactBtn.onclick = ()=>requestTimeInput(req,'active');
            const revBtn = document.createElement("button"); revBtn.textContent="Needs Revisions";
            revBtn.onclick = ()=>requestTimeInput(req,'clientRevisions');
            const deleteBtn = document.createElement("button"); deleteBtn.textContent="Delete"; deleteBtn.onclick=()=>deleteRequest(req.id);
            actionsCell.append(reactBtn, revBtn, deleteBtn);
        } else if (req.status==='clientRevisions') {
            const processBtn = document.createElement("button"); processBtn.textContent="Process";
            processBtn.onclick = () => { req.status='processed'; req.frozenTimeLeft=daysLeft; saveQueue(); renderQueue(); };
            const deleteBtn = document.createElement("button"); deleteBtn.textContent="Delete"; deleteBtn.onclick=()=>deleteRequest(req.id);
            actionsCell.append(processBtn, deleteBtn);
        }
    });

    updateTimers();
}

function updateTimers() {
    queue.forEach(req => {
        const row = document.getElementById(req.id);
        if (!row) return;

        let daysLeft;
        if (req.status==='active'||req.status==='clientRevisions') daysLeft=getBusinessDaysLeft(req.deadline);
        else daysLeft=req.frozenTimeLeft;

        const timerCell = row.querySelector('.timer-cell');
        const statusCell = row.querySelector('.status-cell');

        if (daysLeft<=0 && (req.status==='active'||req.status==='clientRevisions')) row.className='status-warning';
        else row.className=`status-${req.status}`;

        timerCell.textContent=formatTime(daysLeft);

        if ((req.status==='active'||req.status==='clientRevisions') && daysLeft<=0) 
            statusCell.innerHTML='<span style="color:red;font-weight:bold;">Due Today</span>';
        else if (req.status==='clientRevisions') statusCell.textContent='Client Requested Revisions';
        else statusCell.textContent=req.status.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase());
    });
}

document.addEventListener('DOMContentLoaded', () => {
    loadQueue();
    renderQueue();
    setInterval(updateTimers,1000);
    document.getElementById("addRequestBtn").addEventListener("click",addRequest);
    document.getElementById("statusFilter").addEventListener("change",renderQueue);
});
</script>

</body>
</html>
